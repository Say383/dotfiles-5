; -*- mode: emacs-lisp;-*-
;;; $DOOMDIR/mu4e.el -*- lexical-binding: t; -*-

{{- if not .minimal }}
(after! mu4e
  :defer t
  :config
  (cond ((string-equal system-type "gnu/linux")
         (setq sendmail-program "/usr/bin/msmtp"
               send-mail-function 'smtpmail-send-it
               message-sendmail-f-is-evil t
               message-sendmail-extra-arguments '("--read-envelope-from"))
         message-send-mail-function 'message-send-mail-with-sendmail)
        ((string-equal system-type "darwin")
         (setq sendmail-program "/usr/local/bin/msmtp"
               send-mail-function 'smtpmail-send-it
               message-sendmail-f-is-evil t
               message-sendmail-extra-arguments '("--read-envelope-from")
               message-send-mail-function 'message-send-mail-with-sendmail)))

  (set-email-account! "personal"
                      '((mu4e-sent-folder       . "/personal/sent")
                        (mu4e-drafts-folder     . "/personal/drafts")
                        (mu4e-trash-folder      . "/personal/trash")
                        (mu4e-refile-folder     . "/personal/archives")
                        (user-mail-address      . "{{ .email }}")
                        (smtpmail-smtp-user     . "{{ .email }}")
                        (smtpmail-smtp-server   . "{{ .smtp_host }}")
                        (smtpmail-smtp-service  . {{ .smtp_port }})
                        (mu4e-compose-signature . (with-temp-buffer
                                                    (insert-file-contents "~/.config/neomutt/signature.personal")
                                                    (buffer-string)))))
  {{- if .workconf }}
  (set-email-account! "work"
                      '((mu4e-sent-folder       . "/work/sent")
                        (mu4e-drafts-folder     . "/work/drafts")
                        (mu4e-trash-folder      . "/work/trash")
                        (mu4e-refile-folder     . "/work/archives")
                        (smtpmail-smtp-user     . "{{ .work.workmail }}")
                        (user-mail-address      . "{{ .work.workmail }}")
                        (smtpmail-smtp-server   . "{{ .work.smtp_host }}")
                        (smtpmail-smtp-service  . {{ .work.smtp_port }})
                        (mu4e-compose-signature . "---\n{{ .name }}")))
  {{- end }}

  (add-to-list 'mu4e-bookmarks
               '( :name  "University"
                  :query "maildir:'/personal/archives' AND univali OR UNIVALI"
                  :key   ?x) t)

  (add-to-list 'mu4e-bookmarks
               '( :name  "Sent"
                  :query "maildir:/personal/sent"
                  :key   ?s) t)

  (add-to-list 'mu4e-bookmarks
               '( :name "Messages with pdfs"
                  :query "mime:application/pdf"
                  :key ?a) t)

  ;; don't need to run cleanup after indexing for gmail
  (setq mu4e-index-cleanup nil
        ;; because gmail uses labels as folders we can use lazy check since
        ;; messages don't really "move"
        mu4e-index-lazy-check t)

  (setq +mu4e-gmail-accounts '(("{{ .email }}" . "personal")
                               {{ if .workconf }}("{{ .work.workmail }}" . "work"){{ end}})))

{{- end }}
